#!/usr/bin/env rc

fn getl{
	while(test `{ls data | wc -l} -lt $1)
	{
		if(test `{wc -l <links} -lt $1)
			curl -s `{read} |
			tee `{mktemp 'data/XXXXXXX'} |
			grep -o '<a href="[^"]*"' |
			sed 's/^<a href="//;s/"$//' |
			grep -E '^(\/)+wiki\/[^:]+$' |
			sed 's/^/https:\/\/en.wikipedia.org/'
		if not
			curl -s `{read} >`{mktemp 'data/XXXXXXX'}
	}
	exit 1
}

fn gd{
	skip '<script' '</script>' |
	skip '<' '>' |
	tr -s '\t ' '\n' |
	grep '^[a-zA-Z][a-z]\+$' |
	grep -vE '([a-zA-Z])\1{3}' |
	grep -vFf badwords
}

if(test $#* -ne 2){
	echo "mkdict LINK COUNT" >[2=1]
	exit 1
}

touch words
echo $1 >links

ifs='
'

tail -f links | getl $2 | stdbuf -i0 -oL awk '{ if(a[$0]==0) { print($0); a[$0]=1; } }' >>links

cat data/* | gd | sort | uniq -c | sort -n >words

n=`{awk '{ a+=$1 } END { print a }' words}
awk '{ print ($1/'$n')*1000000 " " $2}' words > dict

echo ''>words

