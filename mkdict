#!/usr/bin/env rc

fn getl{
	while(test `{ls data | wc -l} -le $1)
		curl -s `{read} |
		tee `{mktemp 'data/XXXXXXX'} |
		grep -o '<a href="[^"]*"' |
		sed 's/^<a href="//;s/"$//' |
		grep -E '^(\/)+wiki\/[^:]+$' |
		sed 's/^/https:\/\/de.wikipedia.org/'
}

fn gd{
	skip '<script' '</script>' |
	skip '<' '>' |
	tr -s '\t ' '\n' |
	grep '^[a-zA-ZÜÖÄẞüöäß][a-züöäß]\+$' |
	grep -vE '([a-zA-ZüöäßÜÖÄẞ])\1{3}' |
	grep -vFf badwords
}

if(test $#* -ne 2){
	echo "mkdict LINK COUNT" >[2=1]
	exit 1
}

touch dict.txt
echo $1 >links

ifs='
'

tail -f links | getl $2 | stdbuf -i0 -oL fnuu >>links

cat data/* | gd | sort | uniq -c | sort -n >dict.txt

n=`{awk '{ a+=$1 } END { print a }' dict.txt}
awk '{ print ($1/'$n')*1000000 " " $2}' dict.txt > dict

rm dict.txt
